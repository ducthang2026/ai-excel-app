<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>AI Excel</title>
<script src="https://appsforoffice.microsoft.com/lib/1/hosted/office.js"></script>
<style>
body { font-family: Arial; padding: 10px; }
textarea { width: 100%; height: 80px; }
button { width: 100%; padding: 8px; margin-top: 5px; }
#status { margin-top:10px; color:red; }
</style>
</head>
<body>

<h3>AI Excel</h3>
<textarea id="prompt" placeholder="Nhập yêu cầu..."></textarea>
<button onclick="runAI()">Thực hiện</button>
<div id="status"></div>

<script>
async function runAI() {
  const status = document.getElementById("status");
  status.innerText = "Đang xử lý...";

  const prompt = document.getElementById("prompt").value;

  try {
    await Excel.run(async (context) => {
      const sheet = context.workbook.worksheets.getActiveWorksheet();
      const usedRange = sheet.getUsedRange();
      let currentData = "";

      if (usedRange) {
        usedRange.load("values");
        await context.sync();
        currentData = JSON.stringify(usedRange.values);
      }

      const response = await fetch("/api/chat", {
        method: "POST",
        headers: {
          "Content-Type": "application/json"
        },
        body: JSON.stringify({
          prompt: prompt,
          currentData: currentData
        })
      });

      if (!response.ok) {
        throw new Error("Lỗi server: " + response.status);
      }

      const data = await response.json();

      console.log("Response từ server:", data);

      const result = data.result;

      if (!result.headers || !result.rows) {
        throw new Error("AI trả dữ liệu sai format");
      }

      sheet.getUsedRange()?.clear();

      sheet.getRangeByIndexes(0, 0, 1, result.headers.length)
           .values = [result.headers];

      sheet.getRangeByIndexes(1, 0, result.rows.length, result.headers.length)
           .values = result.rows;

      await context.sync();
    });

    status.innerText = "Hoàn thành ✅";
    status.style.color = "green";

  } catch (error) {
    console.error(error);
    status.innerText = "Lỗi: " + error.message;
    status.style.color = "red";
  }
}
</script>

</body>
</html>
