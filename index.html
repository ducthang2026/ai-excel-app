<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>AI Excel</title>
<script src="https://appsforoffice.microsoft.com/lib/1/hosted/office.js"></script>
<style>
body { font-family: Arial; padding: 10px; }
textarea { width: 100%; height: 80px; }
button { width: 100%; padding: 8px; margin-top: 5px; }
</style>
</head>
<body>

<h3>AI Excel</h3>
<textarea id="prompt" placeholder="Nh·∫≠p y√™u c·∫ßu..."></textarea>
<button onclick="runAI()">Th·ª±c hi·ªán</button>

<script>

async function runAI() {
  const prompt = document.getElementById("prompt").value;

  if (!prompt) {
    alert("Vui l√≤ng nh·∫≠p y√™u c·∫ßu");
    return;
  }

  await Excel.run(async (context) => {
    const sheet = context.workbook.worksheets.getActiveWorksheet();

    let currentData = "";
    try {
      const usedRange = sheet.getUsedRange();
      usedRange.load("values");
      await context.sync();
      currentData = JSON.stringify(usedRange.values);
    } catch {
      currentData = "";
    }

    // üîê G·ªåI BACKEND C·ª¶A B·∫†N (KH√îNG G·ªåI OPENAI TR·ª∞C TI·∫æP)
    const response = await fetch("/api/chat", {
      method: "POST",
      headers: {
        "Content-Type": "application/json"
      },
      body: JSON.stringify({
        prompt: prompt,
        currentData: currentData
      })
    });

    const data = await response.json();

    if (!data.choices) {
      alert("L·ªói t·ª´ server");
      return;
    }

    const aiMessage = data.choices[0].message.content;
    const result = JSON.parse(aiMessage);

    // X√≥a sheet c≈©
    try {
      sheet.getUsedRange().clear();
    } catch {}

    // Ghi header
    sheet.getRangeByIndexes(0, 0, 1, result.headers.length)
         .values = [result.headers];

    // Ghi rows
    sheet.getRangeByIndexes(1, 0, result.rows.length, result.headers.length)
         .values = result.rows;

    await context.sync();
  });
}

</script>

</body>
</html>
